# This file contains the fastlane.tools configuration

# sem_ver_tag = UI.select("Select Semantic Versioning Tag: ", ["major", "minor", "patch"])
latest_git_tag = sh("git describe --abbrev=0 --tags")

opt_out_usage
update_fastlane

default_platform(:ios)
# xcode_select("/Applications/Xcode-beta.app")

DEVELOPER_APPLE_ID = ENV["DEVELOPER_APPLE_ID"]
DEVELOPER_APP_IDENTIFIER = ENV["DEVELOPER_APP_IDENTIFIER"]
PROVISIONING_PROFILE_SPECIFIER = ENV["PROVISIONING_PROFILE_SPECIFIER"]
TEMP_KEYCHAIN_USER = ENV["TEMP_KEYCHAIN_USER"]
TEMP_KEYCHAIN_PASSWORD = ENV["TEMP_KEYCHAIN_PASSWORD"]
APPLE_ISSUER_ID = ENV["APPLE_ISSUER_ID"]
APPLE_KEY_ID = ENV["APPLE_KEY_ID"]
APPLE_KEY_CONTENT = ENV["APPLE_KEY_CONTENT"]
GIT_AUTHORIZATION = ENV["GIT_AUTHORIZATION"]
LATEST_TAG = ENV["LATEST_TAG"]

default_platform(:ios)
platform :ios do
  desc "Package and deploy to testflight"
  lane :testflight_release do
    match(type: "appstore")

    latest_build_number = latest_testflight_build_number(
      app_identifier: "#{DEVELOPER_APP_IDENTIFIER}"
    )
    
    increment_build_number({
        build_number: latest_build_number + 1
    })

    increment_version_number_in_xcodeproj(
      scheme: "Lunar",
      version_number: latest_git_tag, 
    )

    build_app(
      scheme: "Lunar",
      silent: true,
      suppress_xcode_output: true
    )
    # upload_to_testflight

  end
end